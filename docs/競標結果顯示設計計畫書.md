# 競標結果顯示設計計畫書

## 一、需求概述

管理員介面需要一個完整的「競標結果」頁面，用於查看特定天數、特定階段（買入/賣出）的所有團隊投標詳情與成交結果。

---

## 二、資料結構說明

### 2.1 投標資料 (bids 表)

每個團隊對每種魚可以提交**最多 2 組**不同的價格+數量組合：

| 欄位 | 說明 |
|------|------|
| `team_id` | 團隊 ID |
| `bid_type` | `buy` 或 `sell` |
| `fish_type` | `A` 或 `B` |
| `price` | 投標價格 |
| `quantity_submitted` | 提交數量 |
| `quantity_fulfilled` | 成交數量（結算後更新）|
| `created_at` | 提交時間 |

**範例：** 第 01 組買入投標
- A魚：價格1=$100 數量1=10kg, 價格2=$90 數量2=5kg
- B魚：價格1=$80 數量1=8kg, 價格2=$70 數量2=3kg
- → 產生 4 筆 bids 記錄

---

## 三、交易邏輯

### 3.1 買入結算邏輯
1. **排序方式：** 按價格**降序**（高價優先），同價按時間升序（早提交優先）
2. **分配規則：** 從最高價開始依序分配，直到供給量用完
3. **成交條件：** 有剩餘供給即可成交
4. **無滯銷：** 買入階段不存在滯銷問題

**公式：**
```
成交量 = min(提交數量, 剩餘供給量)
成交金額 = 成交量 × 價格
```

### 3.2 賣出結算邏輯
1. **滯銷處理（先執行）：**
   - 計算總滯銷量 = 總提交量 × 固定滯銷比例 (2.5%)
   - 從**最高價**開始分配滯銷（高價優先被滯銷）
   - 滯銷的魚收取滯銷費（每公斤罰金）

2. **餐廳購買（後執行）：**
   - 按價格**升序**（低價優先），同價按時間升序
   - 用餐廳資金池從低價開始購買
   - 資金用完後剩餘不成交

**公式：**
```
可賣量 = 提交數量 - 滯銷數量
成交量 = min(可賣量, floor(剩餘資金 / 價格))
成交金額 = 成交量 × 價格
```

---

## 四、UI 設計規格

### 4.1 頁面佈局

```
┌─────────────────────────────────────────────────────────────┐
│ 競標結果                                                      │
├─────────────────────────────────────────────────────────────┤
│ [天數選擇: 第1天 ▼]  [階段選擇: ○買入 ●賣出]                    │
│                                                             │
│ ═══════════════════ 成交價格統計 ═══════════════════════════ │
│ ┌─────────────────────┐  ┌─────────────────────┐           │
│ │ A魚                  │  │ B魚                  │           │
│ │ 最高成交價: $120     │  │ 最高成交價: $95      │           │
│ │ 最低成交價: $85      │  │ 最低成交價: $70      │           │
│ │ 總成交量: 150kg      │  │ 總成交量: 120kg      │           │
│ │ 總成交額: $15,000    │  │ 總成交額: $9,600     │           │
│ └─────────────────────┘  └─────────────────────┘           │
│                                                             │
│ ═══════════════════ A魚投標明細 ════════════════════════════ │
│ ┌───────┬────────┬────────┬────────┬────────┬────────┬────┐│
│ │ 組別  │ 價格1  │ 數量1  │ 價格2  │ 數量2  │ 成交量 │時間││
│ ├───────┼────────┼────────┼────────┼────────┼────────┼────┤│
│ │ 01組  │ $100   │ 10kg   │ $90    │ 5kg    │ 12kg   │14:32│
│ │ 02組  │ $95    │ 8kg    │ $85    │ 6kg    │ 14kg   │14:28│
│ │ 03組  │ $110   │ 12kg   │ -      │ -      │ 12kg   │14:35│
│ │ ...   │        │        │        │        │        │    ││
│ └───────┴────────┴────────┴────────┴────────┴────────┴────┘│
│                                                             │
│ ═══════════════════ B魚投標明細 ════════════════════════════ │
│ ┌───────┬────────┬────────┬────────┬────────┬────────┬────┐│
│ │ 組別  │ 價格1  │ 數量1  │ 價格2  │ 數量2  │ 成交量 │時間││
│ ├───────┼────────┼────────┼────────┼────────┼────────┼────┤│
│ │ 01組  │ $80    │ 8kg    │ $70    │ 3kg    │ 11kg   │14:32│
│ │ ...   │        │        │        │        │        │    ││
│ └───────┴────────┴────────┴────────┴────────┴────────┴────┘│
└─────────────────────────────────────────────────────────────┘
```

### 4.2 篩選控制項

| 控制項 | 類型 | 預設值 | 說明 |
|--------|------|--------|------|
| 天數選擇 | Select | 當前天數 | 下拉選單，顯示 1 ~ currentDay |
| 階段選擇 | Radio | 當前階段 | 買入 / 賣出 |

**預設邏輯：**
- 若當前狀態為 `buying_open` 或 `buying_closed` → 預設顯示「買入」
- 若當前狀態為 `selling_open` 或 `selling_closed` 或 `settled` → 預設顯示「賣出」

### 4.3 成交價格統計區塊

分成 A魚、B魚 兩個 Card，顯示：

| 指標 | 資料來源 | 計算方式 |
|------|----------|----------|
| 最高成交價 | bids | `MAX(price) WHERE quantity_fulfilled > 0` |
| 最低成交價 | bids | `MIN(price) WHERE quantity_fulfilled > 0` |
| 總成交量 | bids | `SUM(quantity_fulfilled)` |
| 總成交額 | bids | `SUM(price × quantity_fulfilled)` |

### 4.4 投標明細表格

**分區：** A魚表格、B魚表格（獨立顯示）

**每列資料（按團隊分組）：**

| 欄位 | 說明 | 備註 |
|------|------|------|
| 組別 | 團隊編號 | `第 01 組`、`第 02 組`... |
| 價格1 | 第一組投標價格 | 若無則顯示 `-` |
| 數量1 | 第一組投標數量 | 若無則顯示 `-` |
| 價格2 | 第二組投標價格 | 若無則顯示 `-` |
| 數量2 | 第二組投標數量 | 若無則顯示 `-` |
| 成交量 | 該組該魚種的總成交量 | `SUM(quantity_fulfilled)` |
| 提交時間 | 最後提交時間 | `HH:mm:ss` 格式 |

**排序：** 按團隊編號升序

---

## 五、資料查詢邏輯

### 5.1 API 端點

```
GET /api/admin/games/:gameId/bids?day=1&bidType=buy
```

**回傳：** 該天該類型的所有 bids（已包含 team_name, team_number）

### 5.2 前端資料處理

```typescript
// 1. 按魚種分組
const fishABids = bids.filter(b => b.fishType === 'A')
const fishBBids = bids.filter(b => b.fishType === 'B')

// 2. 按團隊分組（每隊最多 2 筆同魚種投標）
const groupByTeam = (bids) => {
  const map = new Map<number, TeamBidSummary>()

  for (const bid of bids) {
    if (!map.has(bid.teamId)) {
      map.set(bid.teamId, {
        teamNumber: bid.teamNumber,
        teamName: bid.teamName,
        bids: [],
        totalFulfilled: 0,
        latestTime: bid.createdAt
      })
    }

    const team = map.get(bid.teamId)!
    team.bids.push({ price: bid.price, quantity: bid.quantitySubmitted })
    team.totalFulfilled += (bid.quantityFulfilled || 0)

    if (new Date(bid.createdAt) > new Date(team.latestTime)) {
      team.latestTime = bid.createdAt
    }
  }

  return Array.from(map.values()).sort((a, b) => a.teamNumber - b.teamNumber)
}

// 3. 計算價格統計
const getPriceStats = (bids) => {
  const fulfilled = bids.filter(b => (b.quantityFulfilled || 0) > 0)

  return {
    highestPrice: Math.max(...fulfilled.map(b => b.price)),
    lowestPrice: Math.min(...fulfilled.map(b => b.price)),
    totalVolume: fulfilled.reduce((sum, b) => sum + b.quantityFulfilled, 0),
    totalAmount: fulfilled.reduce((sum, b) => sum + b.price * b.quantityFulfilled, 0)
  }
}
```

---

## 六、實作步驟

### 6.1 後端（若需新增 API）
- [ ] 確認現有 `/api/admin/games/:id/bids` API 支援 `day` 和 `bidType` 參數

### 6.2 前端
1. [ ] 創建新頁面 `/admin/bids` 或修改現有頁面
2. [ ] 新增天數選擇下拉選單
3. [ ] 新增買入/賣出 Radio 切換
4. [ ] 實作成交價格統計區塊（A魚、B魚各一個 Card）
5. [ ] 實作 A魚投標明細表格
6. [ ] 實作 B魚投標明細表格
7. [ ] 按團隊分組顯示（每隊一列）

---

## 七、欄位對照表

### 資料庫 → API → 前端顯示

| 資料庫欄位 | API 欄位 | 前端顯示 |
|-----------|----------|----------|
| `team_number` | `teamNumber` | 組別 |
| `price` | `price` | 價格 |
| `quantity_submitted` | `quantitySubmitted` | 數量 |
| `quantity_fulfilled` | `quantityFulfilled` | 成交量 |
| `created_at` | `createdAt` | 提交時間 |
| `fish_type` | `fishType` | A魚 / B魚 |
| `bid_type` | `bidType` | 買入 / 賣出 |

---

## 八、預期效果

1. 管理員可快速切換查看不同天數、不同階段的投標結果
2. 清楚看到每組對 A魚、B魚 的投標策略（兩組價格+數量）
3. 清楚看到每組的成交量
4. 看到整體的最高/最低成交價，了解市場行情
5. 預設顯示當前階段，減少操作步驟
